<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç»ªé™ªä¼´ App - ç§»åŠ¨ç«¯æ¨¡æ‹Ÿ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8B5CF6; /* ç´«è‰² */
            --color-secondary: #ECFDF5; /* æµ…ç»¿è‰²èƒŒæ™¯ */
            --color-happy: #FBBF24; /* å¼€å¿ƒ é»„è‰² */
            --color-tired: #9CA3AF; /* ç–²æƒ« ç°è‰² */
            --color-calm: #34D399; /* å¹³é™ ç»¿è‰² */
            --color-anxious: #F87171; /* ç„¦è™‘ çº¢è‰² */
            --color-excited: #E879F9; /* å…´å¥‹ ç²‰è‰² */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* è½»æŸ”èƒŒæ™¯ */
        }
        .mood-selector button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mood-selector button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .animal-container {
            transition: transform 0.1s ease-out;
        }
        .animal-interact {
            animation: bounce-heart 0.8s ease-out;
        }
        @keyframes bounce-heart {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .log-container::-webkit-scrollbar {
            width: 4px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 2px;
        }
        /* ç¡®ä¿é¥°å“å›¾æ ‡çš„è¿‡æ¸¡å¹³æ»‘ */
        #accessory-icon {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden min-h-[80vh] flex flex-col">

        <!-- é¡¶éƒ¨çŠ¶æ€æ  / å°åŠ¨ç‰©é™ªä¼´ç•Œé¢ -->
        <div class="p-6 bg-gradient-to-br from-purple-400 to-indigo-500 text-white shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-extrabold" id="current-animal-name">å°å…”å­é™ªä¼´</h1>
                <span id="today-mood-display" class="px-3 py-1 bg-white bg-opacity-30 rounded-full text-sm font-semibold shadow-inner">
                    æœªè®°å½•å¿ƒæƒ…
                </span>
            </div>
            
            <!-- è¿ç»­è®°å½•å¤©æ•° -->
            <div class="text-sm font-medium opacity-80 mb-2">
                è¿ç»­è®°å½•: <span id="continuous-days" class="text-lg font-bold">0</span> å¤©
            </div>
        </div>

        <!-- å°åŠ¨ç‰©/äº’åŠ¨åŒº -->
        <!-- ç§»é™¤äº† animal-bg-container ç±»å’Œ ID -->
        <div id="animal-area" class="flex-grow flex flex-col items-center justify-center p-4 relative overflow-hidden bg-gray-100">
            <!-- é¥°å“ä½©æˆ´ä½ç½® -->
            <div id="accessory-icon" class="absolute top-1/4 transform -translate-y-full text-6xl z-20"></div>
            
            <!-- å°åŠ¨ç‰©ä¸»ä½“ - å¯ç‚¹å‡»åŒºåŸŸ -->
            <div id="animal-display" class="text-[120px] cursor-pointer active:scale-95 transform transition-transform animal-container">
                ğŸ°
            </div>
            
            <!-- äº’åŠ¨åé¦ˆæ¶ˆæ¯ -->
            <div id="feedback-message" class="mt-4 p-2 text-sm text-gray-600 bg-white rounded-lg opacity-0 transition-opacity duration-300 shadow">
                ç‚¹å‡»å°åŠ¨ç‰©äº’åŠ¨å“¦ï¼
            </div>
            
            <div id="reward-message" class="absolute bottom-20 bg-yellow-100 text-yellow-800 p-3 rounded-xl shadow-lg font-bold scale-0 transition-transform duration-500">
                ğŸ‰ è§£é”æ–°é¥°å“ï¼
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª (æ¨¡æ‹ŸVant Tabbar) -->
        <div class="bg-gray-50 border-t border-gray-200 flex justify-around p-3 shadow-inner text-gray-500">
            <button onclick="changeView('home')" class="flex flex-col items-center text-purple-600 font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3m-6 0a1 1 0 001-1v-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v4a1 1 0 001 1zm-6 0h.01" /></svg>
                <span class="text-xs">é¦–é¡µ</span>
            </button>
            <button onclick="changeView('log')" class="flex flex-col items-center hover:text-purple-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span class="text-xs">æ—¥å¿—</span>
            </button>
            <button onclick="changeView('inventory')" class="flex flex-col items-center hover:text-purple-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13v4m0-4V3m-4 5h8m-8 4h8m-8 4h8" /></svg>
                <span class="text-xs">é¥°å“</span>
            </button>
        </div>

        <!-- æµ®åŠ¨çš„å¿ƒæƒ…é€‰æ‹©å™¨ (åªåœ¨é¦–é¡µæ˜¾ç¤º) -->
        <div id="mood-panel" class="p-4 bg-white border-t border-gray-200 mood-selector">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">è®°å½•ä»Šæ—¥å¿ƒæƒ…</h3>
            <div class="grid grid-cols-5 gap-3">
                <button data-mood="HAPPY" class="flex flex-col items-center p-2 rounded-xl bg-yellow-100 text-yellow-800" onclick="recordMood('HAPPY')">
                    <span class="text-2xl">ğŸ˜Š</span>
                    <span class="text-xs mt-1">å¼€å¿ƒ</span>
                </button>
                <button data-mood="CALM" class="flex flex-col items-center p-2 rounded-xl bg-green-100 text-green-800" onclick="recordMood('CALM')">
                    <span class="text-2xl">ğŸ˜Œ</span>
                    <span class="text-xs mt-1">å¹³é™</span>
                </button>
                <button data-mood="TIRED" class="flex flex-col items-center p-2 rounded-xl bg-gray-200 text-gray-800" onclick="recordMood('TIRED')">
                    <span class="text-2xl">ğŸ˜´</span>
                    <span class="text-xs mt-1">ç–²æƒ«</span>
                </button>
                <button data-mood="ANXIOUS" class="flex flex-col items-center p-2 rounded-xl bg-red-100 text-red-800" onclick="recordMood('ANXIOUS')">
                    <span class="text-2xl">ğŸ˜Ÿ</span>
                    <span class="text-xs mt-1">ç„¦è™‘</span>
                </button>
                <button data-mood="EXCITED" class="flex flex-col items-center p-2 rounded-xl bg-pink-100 text-pink-800" onclick="recordMood('EXCITED')">
                    <span class="text-2xl">ğŸ¥³</span>
                    <span class="text-xs mt-1">å…´å¥‹</span>
                </button>
            </div>
        </div>

        <!-- æ—¥å¿—é¡µé¢ (éšè—) -->
        <div id="log-view" class="p-6 hidden flex-col flex-grow bg-gray-50">
            <h2 class="text-xl font-bold mb-4 text-purple-700">å¿ƒæƒ…è®°å½•æ—¥å¿—</h2>
            <div id="history-list" class="space-y-3 overflow-y-auto log-container flex-grow max-h-full">
                <!-- æ—¥å¿—é¡¹å°†åœ¨è¿™é‡Œæ’å…¥ -->
            </div>
        </div>

        <!-- é¥°å“å’ŒåŠ¨ç‰©é€‰æ‹©é¡µé¢ (éšè—) -->
        <div id="inventory-view" class="p-6 hidden flex-col flex-grow bg-gray-50 overflow-y-auto">
            <div id="inventory-list" class="space-y-8 pb-4">
                <!-- åŠ¨ç‰©é€‰æ‹©å’Œé¥°å“åˆ—è¡¨å°†åœ¨è¿™é‡Œæ’å…¥ -->
            </div>
        </div>

    </div>

    <script>
        // --- 1. æ•°æ®æ¨¡å‹ä¸çŠ¶æ€ (State & Data Model) ---
        const MOODS = {
            HAPPY: { cn: 'å¼€å¿ƒ', emoji: 'ğŸ˜Š', color: 'bg-yellow-100 text-yellow-800' },
            CALM: { cn: 'å¹³é™', emoji: 'ğŸ˜Œ', color: 'bg-green-100 text-green-800' },
            TIRED: { cn: 'ç–²æƒ«', emoji: 'ğŸ˜´', color: 'bg-gray-200 text-gray-800' },
            ANXIOUS: { cn: 'ç„¦è™‘', emoji: 'ğŸ˜Ÿ', color: 'bg-red-100 text-red-800' },
            EXCITED: { cn: 'å…´å¥‹', emoji: 'ğŸ¥³', color: 'bg-pink-100 text-pink-800' },
            UNKNOWN: { cn: 'æœªè®°å½•', emoji: 'â“', color: 'bg-white text-gray-500' }
        };

        // ğŸ¾ å°åŠ¨ç‰©å®šä¹‰ - åªæœ‰åŸºç¡€è¡¨æƒ…
        const ANIMALS = {
            RABBIT: { id: 'RABBIT', name: 'å°å…”å­', emoji: 'ğŸ°' },
            CAT: { id: 'CAT', name: 'é»‘çŒ«', emoji: 'ğŸˆâ€â¬›' },
            PANDA: { id: 'PANDA', name: 'å°ç†ŠçŒ«', emoji: 'ğŸ¼' },
            DOG: { id: 'DOG', name: 'è¨æ‘©è€¶', emoji: 'ğŸ•' },
            FOX: { id: 'FOX', name: 'å°ç‹ç‹¸', emoji: 'ğŸ¦Š' },
            HEDGEHOG: { id: 'HEDGEHOG', name: 'å°åˆºçŒ¬', emoji: 'ğŸ¦”' },
        };
        
        // ğŸ’¬ å°åŠ¨ç‰©å¯¹è¯å®šä¹‰ (ä¿æŒä¸å˜)
        const ANIMAL_DIALOGUES = {
            RABBIT: {
                HAPPY: "å¤ªæ£’äº†ï¼ä½ çš„å¿«ä¹æ„ŸæŸ“äº†æˆ‘ï¼Œæˆ‘ä»¬ä¸€èµ·å»å¥”è·‘å§ï¼",
                EXCITED: "å“‡ï¼æ„Ÿè§‰åˆ°äº†ä½ çš„èƒ½é‡ï¼Œè®©æˆ‘ä»¬ä¸€èµ·è·³ä¸ªèˆå§ï¼",
                CALM: "æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„å¹³é™ï¼Œæ·±å‘¼å¸ï¼Œäº«å—è¿™ä¸€åˆ»çš„å®é™å§ã€‚",
                TIRED: "æ‘¸æ‘¸å¤´ï¼Œè¾›è‹¦äº†ã€‚ç°åœ¨æ”¾æ¾ä¸‹æ¥ï¼Œæˆ‘ä¼šåœ¨æ—è¾¹å®ˆæŠ¤ä½ å…¥ç¡çš„ã€‚",
                ANXIOUS: "æ²¡äº‹çš„ï¼Œæˆ‘åœ¨ä½ èº«è¾¹ï¼æˆ‘ä»¬æ•°ä¸‰ä¸‹ï¼ŒæŠŠé‚£äº›ä¸å®‰éƒ½å¹èµ°ï¼Œå¥½å—ï¼Ÿ",
                UNKNOWN: "ä½ æƒ³å’Œæˆ‘è¯´è¯´ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿæˆ‘åœ¨å¬å“¦ã€‚",
            },
            CAT: {
                HAPPY: "å–µ~ çœ‹åˆ°ä½ å¼€å¿ƒï¼Œæˆ‘ä¹Ÿè§‰å¾—ä»Šå¤©çš„é˜³å…‰æ ¼å¤–å¥½ã€‚",
                EXCITED: "å…´å¥‹ï¼Ÿåˆ«å¿˜äº†ä¹Ÿè¦ä¿æŒä¼˜é›…ã€‚è®©æˆ‘å¸®ä½ æ¢³æ¢³æ¯›~",
                CALM: "å‘¼å™œå™œ... é è¿‘æˆ‘ï¼Œä¸€èµ·äº«å—è¿™ä»½åˆåçš„å®‰å®ã€‚",
                TIRED: "ä¸è¦æ‹…å¿ƒï¼Œä¼‘æ¯æ˜¯æœ€å¥½çš„æ²»æ„ˆã€‚è®©æˆ‘é ç€ä½ ï¼Œç»™ä½ æ¸©æš–ã€‚",
                ANXIOUS: "è™½ç„¶æˆ‘ä¸å¤ªæ‡‚ï¼Œä½†æˆ‘ä¼šä¸€ç›´å¬ç€ï¼Œä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨é¢å¯¹ã€‚",
                UNKNOWN: "ä»Šå¤©çš„ä½ çœ‹èµ·æ¥æœ‰ç‚¹ç¥ç§˜ï¼Œè¦ä¸è¦æ¥ç‚¹å°é±¼å¹²ï¼Ÿ",
            },
            PANDA: {
                HAPPY: "å—~ å¿«ä¹çš„æ—¶å€™è¦å¤šåƒç«¹å­ï¼ç»™ä½ ä¸€ä¸ªç«¹å¶æŠ±æŠ±ï¼",
                EXCITED: "å“‡ï¼Œè¿™æ¯”åƒç¬‹è¿˜è®©äººå…´å¥‹ï¼æ…¢ç‚¹ï¼Œæ…¢ç‚¹ï¼Œæ³¨æ„å®‰å…¨ï¼",
                CALM: "æ…¢æ…¢æ¥ï¼Œä¸ç€æ€¥ã€‚æˆ‘åœ¨è¿™é‡Œï¼Œä¸€åˆ‡éƒ½å¥½ã€‚",
                TIRED: "ç´¯äº†å°±è¶´ç€å§ï¼ŒæŠŠçƒ¦æ¼éƒ½å¿˜äº†ã€‚ä»Šå¤©ä¸åšä»»ä½•äº‹ä¹Ÿæ²¡å…³ç³»ã€‚",
                ANXIOUS: "åˆ«æ€•ï¼Œæˆ‘ä¼šä¿æŠ¤ä½ çš„ã€‚é‚£äº›ä¸å¥½çš„æƒ…ç»ªï¼Œè®©æˆ‘å¸®ä½ åƒæ‰ï¼",
                UNKNOWN: "ä»Šå¤©è¿˜æ²¡è®°å½•å¿ƒæƒ…å‘¢ã€‚å¿«å‘Šè¯‰æˆ‘ï¼Œä½ æ˜¯å¼€å¿ƒè¿˜æ˜¯æƒ³ç¡è§‰ï¼Ÿ",
            },
            DOG: {
                HAPPY: "æ±ªï¼å¤ªå¼€å¿ƒå•¦ï¼æˆ‘ä»¬ä¸€èµ·ç©æŠ›çƒæ¸¸æˆå§ï¼",
                EXCITED: "ç‹‚å¥”å§ï¼æˆ‘çš„ä¸»äººï¼æˆ‘å·²ç»å‡†å¤‡å¥½ä¸€èµ·å†²å‘å¿«ä¹äº†ï¼",
                CALM: "å‘¼... é—»åˆ°äº†å¹³é™çš„å‘³é“ã€‚æ¥ï¼ŒæŠŠæ‰‹ç»™æˆ‘ï¼Œæˆ‘ä»¬é™é™åœ°å¾…ä¼šå„¿ã€‚",
                TIRED: "ä¼‘æ¯æ˜¯ä¸ºäº†è·‘å¾—æ›´è¿œï¼åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¼šå¸®ä½ æš–è„šè„šçš„ã€‚",
                ANXIOUS: "åˆ«æ€•ï¼æˆ‘ä¼šå¤§å£°å å«ï¼ŒæŠŠé‚£äº›åæƒ…ç»ªéƒ½å“è·‘ï¼æ±ªï¼",
                UNKNOWN: "å¿«å‘Šè¯‰æˆ‘ä½ çš„å¿ƒæƒ…ï¼Œæˆ‘æ‰èƒ½çŸ¥é“è¯¥æ€ä¹ˆè®©ä½ æ›´å¼€å¿ƒå‘€ï¼",
            },
            FOX: {
                HAPPY: "ä½ çš„å¥½å¿ƒæƒ…æ˜¯æˆ‘çš„èƒ½é‡æ¥æºï¼Œç»§ç»­ä¿æŒè¿™ä»½æ´»åŠ›ï¼",
                EXCITED: "å“ˆå“ˆï¼Œæˆ‘ä¹Ÿè·Ÿç€ä½ å˜å¾—ç‹¡çŒ¾åˆå…´å¥‹äº†ï¼ä»Šå¤©è¦åšç‚¹ä»€ä¹ˆæœ‰è¶£çš„äº‹å‘¢ï¼Ÿ",
                CALM: "ä¸–ç•Œå¾ˆå®‰é™ï¼Œä½ ä¹Ÿå¾ˆæ”¾æ¾ã€‚çœŸæ˜¯ä¸€ä¸ªé€‚åˆæ€è€ƒçš„å¥½æ—¥å­ã€‚",
                TIRED: "å……ç”µæ—¶é—´åˆ°ï¼æˆ‘çŸ¥é“ä½ å¾ˆç´¯ï¼Œä½†åˆ«å¿˜äº†ç»™è‡ªå·±ä¸€ä¸ªæ‹¥æŠ±ã€‚",
                ANXIOUS: "ç„¦è™‘å°±åƒä¸€å›¢è¿·é›¾ï¼Œä½†æˆ‘ä»¬èƒ½ä¸€èµ·æ‰¾åˆ°å‡ºå£ã€‚ç›¸ä¿¡è‡ªå·±ã€‚",
                UNKNOWN: "æ— è®ºä½ é€‰æ‹©äº†ä»€ä¹ˆï¼Œæˆ‘éƒ½æ”¯æŒä½ ã€‚è®°å½•ä¸€ä¸‹å¿ƒæƒ…ä¼šæ›´å¥½å“¦ã€‚",
            },
            HEDGEHOG: {
                HAPPY: "å¤ªå¥½äº†ï¼æˆ‘çš„åˆºéƒ½è½¯äº†ä¸€ç‚¹ç‚¹å‘¢ã€‚ç»§ç»­ä¿æŒå“¦ï¼",
                EXCITED: "å‘¼å‘¼ï¼æˆ‘æ„Ÿè§‰è¦é£èµ·æ¥äº†ï¼ä¸è¿‡åˆ«å¤ªæ¿€åŠ¨ï¼Œåˆºæ‰åˆ°ä½ å°±ä¸å¥½äº†ï¼",
                CALM: "åˆ«åŠ¨ï¼Œåˆ«åŠ¨ã€‚å®‰é™åœ°å¬ä¸€å¬å‘¨å›´çš„å£°éŸ³ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ²»æ„ˆï¼Ÿ",
                TIRED: "æˆ‘ç°åœ¨ä¸æƒ³å·èµ·æ¥ï¼Œå› ä¸ºæˆ‘æƒ³è®©ä½ çŸ¥é“æˆ‘åœ¨ä½ èº«è¾¹ã€‚è¾›è‹¦å•¦ã€‚",
                ANXIOUS: "ä½ çš„ç´§å¼ æˆ‘æ„Ÿå—åˆ°äº†ï¼Œæ·±å‘¼å¸ã€‚æˆ‘çš„å°åˆºä¸ä¼šæ‰åˆ°ä½ çš„ï¼Œé è¿‘ç‚¹ã€‚",
                UNKNOWN: "å—¯ï¼Ÿä½ ä»Šå¤©æœ‰ç‚¹å®‰é™ã€‚ä¹Ÿè®¸è®°å½•ä¸‹æ¥ï¼Œå°±èƒ½æ‰¾åˆ°ç­”æ¡ˆã€‚",
            },
        };

        const INITIAL_INVENTORY = {
            flower: { id: 'flower', name: 'å°èŠ±', emoji: 'ğŸŒ¸', requiredDays: 0, unlocked: true, equipped: false },
            hat: { id: 'hat', name: 'å°å¸½å­', emoji: 'ğŸ©', requiredDays: 3, unlocked: false, equipped: false },
            scarf: { id: 'scarf', name: 'å°å›´å·¾', emoji: 'ğŸ§£', requiredDays: 5, unlocked: false, equipped: false },
            bowtie: { id: 'bowtie', name: 'å°é¢†ç»“', emoji: 'ğŸ€', requiredDays: 7, unlocked: false, equipped: false },
            glasses: { id: 'glasses', name: 'å°çœ¼é•œ', emoji: 'ğŸ‘“', requiredDays: 10, unlocked: false, equipped: false },
            crown: { id: 'crown', name: 'å°çš‡å† ', emoji: 'ğŸ‘‘', requiredDays: 14, unlocked: false, equipped: false },
        };

        let state = {
            currentAnimalId: 'RABBIT', // é»˜è®¤å°åŠ¨ç‰©
            todayMood: 'UNKNOWN', // å½“å‰è®°å½•çš„å¿ƒæƒ…
            historyRecords: [], // [{ date: '2023-01-01', mood: 'HAPPY' }, ...]
            accessoryInventory: JSON.parse(JSON.stringify(INITIAL_INVENTORY)),
            continuousDays: 0,
            currentView: 'home'
        };

        // --- 2. å·¥å…·å‡½æ•° (Utility Functions) ---

        /** è·å–å½“å‰æ—¥æœŸ YYYY-MM-DD */
        function getCurrentDate() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- 3. æ•°æ®æŒä¹…åŒ– (Storage) ---

        /** ä» localStorage åŠ è½½æ•°æ® */
        function loadData() {
            const storedState = localStorage.getItem('companionApp_state');
            if (storedState) {
                try {
                    const loadedState = JSON.parse(storedState);
                    // è¦†ç›–çŠ¶æ€ï¼Œä½†ä¿ç•™é»˜è®¤å€¼ä»¥é˜²æ–°å­—æ®µä¸¢å¤±
                    state = { ...state, ...loadedState };

                    // ç¡®ä¿ currentAnimalId æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤å€¼
                    if (!ANIMALS[state.currentAnimalId]) {
                        state.currentAnimalId = 'RABBIT';
                    }
                    
                    // ç¡®ä¿é¥°å“åº“å­˜åŒ…å«æ‰€æœ‰åˆå§‹é¥°å“ï¼Œå¹¶ä»åŠ è½½çš„æ•°æ®ä¸­æ›´æ–°çŠ¶æ€
                    for (const id in INITIAL_INVENTORY) {
                        if (loadedState.accessoryInventory && loadedState.accessoryInventory[id]) {
                            state.accessoryInventory[id] = loadedState.accessoryInventory[id];
                        } else if (!state.accessoryInventory[id]) {
                            // å¦‚æœåŠ è½½çš„æ•°æ®æ²¡æœ‰ï¼Œä½¿ç”¨åˆå§‹å€¼
                            state.accessoryInventory[id] = INITIAL_INVENTORY[id];
                        }
                    }
                    console.log('æ•°æ®åŠ è½½æˆåŠŸã€‚');
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                }
            }
            updateContinuousDays(); // æ¯æ¬¡åŠ è½½åé‡æ–°è®¡ç®—è¿ç»­å¤©æ•°
        }

        /** ä¿å­˜æ•°æ®åˆ° localStorage */
        function saveData() {
            localStorage.setItem('companionApp_state', JSON.stringify(state));
        }

        // --- 4. æ ¸å¿ƒé€»è¾‘ (Core Logic) ---

        /** è®¡ç®—è¿ç»­è®°å½•å¤©æ•° */
        function updateContinuousDays() {
            // ç®€åŒ–ï¼šè¿™é‡Œä»…ä¾èµ–è®°å½•æ•°ä½œä¸ºæ¿€åŠ±
            state.continuousDays = state.historyRecords.length; 
        }

        /** æ£€æŸ¥å¹¶å¥–åŠ±é¥°å“ */
        function checkReward() {
            const currentDays = state.continuousDays;
            let unlockedSomething = false;

            for (const id in state.accessoryInventory) {
                const acc = state.accessoryInventory[id];
                if (!acc.unlocked && acc.requiredDays <= currentDays) {
                    acc.unlocked = true;
                    unlockedSomething = true;
                    console.log(`ğŸ‰ è§£é”äº† ${acc.name}ï¼`);
                }
            }

            if (unlockedSomething) {
                showRewardMessage();
                saveData();
            }
        }
        
        /** æ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯ */
        function showRewardMessage() {
            const msgEl = document.getElementById('reward-message');
            msgEl.classList.remove('scale-0', 'opacity-0');
            msgEl.classList.add('scale-100', 'opacity-100');
            setTimeout(() => {
                msgEl.classList.remove('scale-100', 'opacity-100');
                msgEl.classList.add('scale-0', 'opacity-0');
            }, 3000);
        }

        /** è®°å½•å¿ƒæƒ… */
        function recordMood(mood) {
            const today = getCurrentDate();
            const lastIndex = state.historyRecords.length - 1;

            if (lastIndex >= 0 && state.historyRecords[lastIndex].date === today) {
                // æ›´æ–°ä»Šæ—¥è®°å½•
                state.historyRecords[lastIndex].mood = mood;
            } else {
                // æ–°å¢è®°å½•
                state.historyRecords.push({ date: today, mood: mood });
                state.continuousDays++; // ç®€åŒ–ï¼šæ¯è®°å½•ä¸€æ¬¡å°±+1å¤© (é™¤éæ˜¯æ›´æ–°)
                checkReward();
            }

            state.todayMood = mood;
            saveData();
            updateUI();

            // æç¤ºç”¨æˆ·è®°å½•æˆåŠŸ
            const msg = `å¿ƒæƒ…è®°å½•æˆåŠŸ: ${MOODS[mood].cn}!`;
            showFeedback(msg);
        }

        /** ä½©æˆ´é¥°å“ */
        function equipAccessory(id) {
            const acc = state.accessoryInventory[id];
            if (!acc || !acc.unlocked) {
                showFeedback(`é¥°å“ [${acc ? acc.name : id}] å°šæœªè§£é”!`);
                return;
            }

            // å¸ä¸‹æ‰€æœ‰
            for (const key in state.accessoryInventory) {
                state.accessoryInventory[key].equipped = false;
            }
            
            // ä½©æˆ´æ–°çš„
            acc.equipped = true;
            showFeedback(`å·²ä¸º ${ANIMALS[state.currentAnimalId].name} ä½©æˆ´ ${acc.name}ï¼`);
            saveData();
            updateUI();
        }
        
        /** åˆ‡æ¢å°åŠ¨ç‰© */
        function selectAnimal(animalId) {
            const animal = ANIMALS[animalId];
            if (!animal) {
                showFeedback(`æ‰¾ä¸åˆ°åŠ¨ç‰©ID: ${animalId}`);
                return;
            }
            if (state.currentAnimalId === animalId) {
                showFeedback(`ä½ çš„æœ‹å‹å·²ç»æ˜¯ ${animal.name} å•¦ï¼`);
                return;
            }

            state.currentAnimalId = animalId;
            // åˆ‡æ¢åŠ¨ç‰©åé»˜è®¤å¸ä¸‹æ‰€æœ‰é¥°å“ï¼Œå› ä¸ºé¥°å“å¯èƒ½ä¸å…¼å®¹
            for (const key in state.accessoryInventory) {
                state.accessoryInventory[key].equipped = false;
            }
            
            showFeedback(`å·²åˆ‡æ¢ä¼´ä¾£ï¼š${animal.name}ï¼è¯·é‡æ–°é€‰æ‹©é¥°å“ã€‚`);
            saveData();
            updateUI();
        }

        /** å°åŠ¨ç‰©ç‚¹å‡»äº’åŠ¨ (æ ¹æ®å¿ƒæƒ…å’ŒåŠ¨ç‰©æä¾›å®šåˆ¶å¯¹è¯) */
        function animateAnimal() {
            const animalEl = document.getElementById('animal-display');
            const currentAnimalId = state.currentAnimalId;
            const mood = state.todayMood in MOODS ? state.todayMood : 'UNKNOWN'; // ç¡®ä¿ mood å­˜åœ¨äº MOODS ä¸­
            
            // 1. è·å–å®šåˆ¶å¯¹è¯
            let dialogue = ANIMAL_DIALOGUES[currentAnimalId] ? 
                           (ANIMAL_DIALOGUES[currentAnimalId][mood] || ANIMAL_DIALOGUES[currentAnimalId]['UNKNOWN']) : 
                           "ç‚¹å‡»å°åŠ¨ç‰©äº’åŠ¨å“¦ï¼"; // é»˜è®¤/å®‰å…¨å¯¹è¯
            
            // 2. æ’­æ”¾åŠ¨ç”»
            let animationClass = '';
            
            if (mood === 'HAPPY' || mood === 'EXCITED') {
                // ç§¯ææƒ…ç»ªï¼šå¼¹è·³åŠ¨ç”»
                animationClass = 'animal-interact';
            } else if (mood === 'TIRED' || mood === 'ANXIOUS') {
                // æ¶ˆæ/ä½èƒ½é‡æƒ…ç»ªï¼šè½»å¾®ä¸‹æ²‰æˆ–ç§»åŠ¨
                animalEl.style.transform = 'translateY(5px) scale(0.98)';
            } else {
                // å¹³é™/æœªè®°å½•æƒ…ç»ªï¼šæ”¾å¤§
                animalEl.style.transform = 'scale(1.05)';
            }

            if (animationClass) {
                animalEl.classList.add(animationClass);
            }
            
            // 3. æ˜¾ç¤ºåé¦ˆå¯¹è¯
            showFeedback(dialogue);

            // 4. æ¸…é™¤åŠ¨ç”»/çŠ¶æ€
            setTimeout(() => {
                if (animationClass) {
                    animalEl.classList.remove(animationClass);
                }
                animalEl.style.transform = '';
            }, 800);
        }

        /** æ˜¾ç¤ºç®€çŸ­çš„åé¦ˆä¿¡æ¯ */
        function showFeedback(message) {
            const feedbackEl = document.getElementById('feedback-message');
            feedbackEl.textContent = message;
            feedbackEl.classList.remove('opacity-0');
            feedbackEl.classList.add('opacity-100');
            setTimeout(() => {
                feedbackEl.classList.remove('opacity-100');
                feedbackEl.classList.add('opacity-0');
            }, 2500);
        }

        // --- 5. ç•Œé¢æ¸²æŸ“ (UI Rendering) ---

        /** æ¸²æŸ“ä¸»ç•Œé¢å’ŒçŠ¶æ€ */
        function updateUI() {
            const moodData = MOODS[state.todayMood] || MOODS.UNKNOWN;
            const currentAnimalData = ANIMALS[state.currentAnimalId] || ANIMALS.RABBIT;
            
            // 1. é¡¶éƒ¨çŠ¶æ€æ 
            document.getElementById('current-animal-name').textContent = `${currentAnimalData.name}é™ªä¼´`;
            document.getElementById('today-mood-display').textContent = moodData.cn;
            document.getElementById('continuous-days').textContent = state.continuousDays;

            // 2. å°åŠ¨ç‰©å¤–è§‚ - å§‹ç»ˆæ˜¾ç¤ºé»˜è®¤ emoji
            const animalEmoji = currentAnimalData.emoji;
            document.getElementById('animal-display').textContent = animalEmoji;

            // 3. é¥°å“é€»è¾‘
            let accessoryEmoji = '';
            const accessoryIconEl = document.getElementById('accessory-icon');

            // æ£€æŸ¥æ˜¯å¦ä½©æˆ´äº†é¥°å“
            let equippedPermanentAccessory = null;
            for (const id in state.accessoryInventory) {
                if (state.accessoryInventory[id].equipped) {
                    equippedPermanentAccessory = state.accessoryInventory[id].emoji;
                    break;
                }
            }
            
            if (equippedPermanentAccessory) {
                // å¦‚æœæœ‰ä½©æˆ´çš„é¥°å“ï¼Œæ˜¾ç¤ºé¥°å“
                accessoryEmoji = equippedPermanentAccessory;
                // è®¾ç½®é¥°å“é»˜è®¤ä½ç½®
                accessoryIconEl.classList.add('top-1/4', '-translate-y-full', 'text-6xl');
                accessoryIconEl.classList.remove('top-1/2', 'translate-y-0', 'text-4xl', 'opacity-80');
            } else {
                // æ²¡æœ‰ä»»ä½•é¥°å“
                accessoryIconEl.classList.add('top-1/4', '-translate-y-full', 'text-6xl');
                accessoryIconEl.classList.remove('top-1/2', 'translate-y-0', 'text-4xl', 'opacity-80');
                accessoryEmoji = '';
            }

            document.getElementById('accessory-icon').textContent = accessoryEmoji;

            // 4. åˆ‡æ¢è§†å›¾
            changeView(state.currentView, false); // ç¡®ä¿å½“å‰è§†å›¾çš„å†…å®¹è¢«æ›´æ–°
        }

        /** æ¸²æŸ“æ—¥å¿—è§†å›¾ */
        function renderLogView() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            
            if (state.historyRecords.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 mt-8">è¿˜æ²¡æœ‰è®°å½•å‘¢ï¼Œå¿«å»è®°å½•ç¬¬ä¸€æ¡å¿ƒæƒ…å§ï¼</p>';
                return;
            }

            // åå‘è¿­ä»£æ˜¾ç¤ºæœ€è¿‘çš„è®°å½•
            for (let i = state.historyRecords.length - 1; i >= 0; i--) {
                const record = state.historyRecords[i];
                const moodData = MOODS[record.mood] || MOODS.UNKNOWN;
                const item = document.createElement('div');
                item.className = `p-3 rounded-xl flex items-center shadow-md ${moodData.color}`;
                item.innerHTML = `
                    <span class="text-3xl mr-4">${moodData.emoji}</span>
                    <div>
                        <p class="font-bold text-lg">${moodData.cn}</p>
                        <p class="text-sm opacity-80">${record.date}</p>
                    </div>
                `;
                listEl.appendChild(item);
            }
        }

        /** æ¸²æŸ“é¥°å“ä»“åº“å’ŒåŠ¨ç‰©é€‰æ‹©è§†å›¾ */
        function renderInventoryView() {
            const listEl = document.getElementById('inventory-list');
            listEl.innerHTML = '';

            // --- 1. å°åŠ¨ç‰©é€‰æ‹©åŒºåŸŸ ---
            const animalSection = document.createElement('div');
            animalSection.className = 'mb-8 p-4 bg-white rounded-xl shadow-lg';
            animalSection.innerHTML = `
                <h3 class="text-xl font-extrabold mb-4 text-purple-700 border-b pb-2">æ›´æ¢ä½ çš„å°ä¼´ä¾£</h3>
                <div class="grid grid-cols-3 gap-4">
                    ${Object.values(ANIMALS).map(animal => {
                        const isCurrent = animal.id === state.currentAnimalId;
                        // å§‹ç»ˆæ˜¾ç¤ºåŠ¨ç‰©çš„é»˜è®¤è¡¨æƒ…
                        const displayEmoji = animal.emoji; 
                        return `
                            <button onclick="selectAnimal('${animal.id}')"
                                    class="p-4 rounded-xl shadow-inner flex flex-col items-center justify-center transition-all duration-200
                                            ${isCurrent ? 'bg-purple-100 ring-2 ring-purple-500' : 'bg-gray-50 hover:bg-gray-100'}">
                                <span class="text-4xl sm:text-5xl">${displayEmoji}</span>
                                <span class="text-xs font-semibold mt-2 ${isCurrent ? 'text-purple-700' : 'text-gray-700'}">${animal.name}</span>
                                ${isCurrent ? '<span class="text-[10px] text-purple-600 font-bold mt-1">å½“å‰</span>' : ''}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            listEl.appendChild(animalSection);

            // --- 2. é¥°å“ä»“åº“åŒºåŸŸ ---
            const accessorySection = document.createElement('div');
            accessorySection.className = 'p-4 bg-white rounded-xl shadow-lg';
            accessorySection.innerHTML = `
                <h3 class="text-xl font-extrabold mb-4 text-purple-700 border-b pb-2">é¥°å“ä»“åº“</h3>
                <p class="text-sm text-gray-500 mb-4">è¿ç»­è®°å½•å¿ƒæƒ…å¯è§£é”æ›´å¤šé¥°å“å“¦ï¼</p>
                <div id="accessory-list-container" class="space-y-4">
                    <!-- é¥°å“åˆ—è¡¨ -->
                </div>
            `;
            listEl.appendChild(accessorySection);
            
            const accessoryListContainer = accessorySection.querySelector('#accessory-list-container');

            for (const id in state.accessoryInventory) {
                const acc = state.accessoryInventory[id];
                let buttonText, buttonClass, buttonAction;

                if (acc.equipped) {
                    buttonText = 'å·²ä½©æˆ´';
                    buttonClass = 'bg-purple-600 text-white cursor-default';
                    buttonAction = '';
                } else if (acc.unlocked) {
                    buttonText = 'ä½©æˆ´';
                    buttonClass = 'bg-green-500 text-white hover:bg-green-600';
                    buttonAction = `equipAccessory('${acc.id}')`;
                } else {
                    buttonText = `æœªè§£é” (${acc.requiredDays} å¤©)`;
                    buttonClass = 'bg-gray-300 text-gray-600 cursor-not-allowed';
                    buttonAction = '';
                }

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-xl shadow-md';
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-3xl mr-4">${acc.emoji}</span>
                        <div>
                            <p class="font-bold text-gray-800">${acc.name}</p>
                            <p class="text-xs text-gray-500">ç”¨äº ${ANIMALS[state.currentAnimalId].name}</p>
                        </div>
                    </div>
                    <button class="px-4 py-2 text-sm font-semibold rounded-full transition-colors ${buttonClass}"
                            ${buttonAction ? `onclick="${buttonAction}"` : 'disabled'}>
                        ${buttonText}
                    </button>
                `;
                accessoryListContainer.appendChild(item);
            }
        }

        /** è§†å›¾åˆ‡æ¢ */
        function changeView(view, updateNav = true) {
            state.currentView = view;
            
            // éšè—æ‰€æœ‰ç‰¹å®šè§†å›¾å…ƒç´ 
            document.getElementById('log-view').classList.add('hidden');
            document.getElementById('inventory-view').classList.add('hidden', 'flex-col');
            document.getElementById('mood-panel').classList.add('hidden');
            // è·å–ä¸»äº’åŠ¨åŒºåŸŸçš„çˆ¶å®¹å™¨
            const mainContentAreaParent = document.querySelector('#animal-area').parentElement;
            document.getElementById('animal-area').style.display = 'none';

            if (view === 'home') {
                document.getElementById('animal-area').style.display = 'flex';
                document.getElementById('mood-panel').classList.remove('hidden');
            } else if (view === 'log') {
                document.getElementById('log-view').classList.remove('hidden');
                document.getElementById('log-view').classList.add('flex-col');
                renderLogView();
            } else if (view === 'inventory') {
                document.getElementById('inventory-view').classList.remove('hidden');
                document.getElementById('inventory-view').classList.add('flex-col');
                renderInventoryView();
            }

            if (updateNav) {
                // æ›´æ–°åº•éƒ¨å¯¼èˆªé«˜äº®çŠ¶æ€ (ç®€å•å®ç°)
                const navButtons = document.querySelectorAll('.bg-gray-50 button');
                navButtons.forEach(btn => {
                    const btnView = btn.getAttribute('onclick').match(/'(.*?)'/)[1];
                    if (btnView === view) {
                        btn.classList.add('text-purple-600', 'font-bold');
                        btn.classList.remove('hover:text-purple-600');
                    } else {
                        btn.classList.remove('text-purple-600', 'font-bold');
                        btn.classList.add('hover:text-purple-600');
                    }
                });
            }
        }

        // --- 6. åˆå§‹åŒ– (Initialization) ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateUI();
            
            // ç»‘å®šå°åŠ¨ç‰©ç‚¹å‡»äº‹ä»¶
            document.getElementById('animal-display').addEventListener('click', animateAnimal);
            
            // é»˜è®¤æ˜¾ç¤ºé¦–é¡µ
            changeView('home');
        });

        // å°†æ ¸å¿ƒå‡½æ•°æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ HTML èƒ½å¤Ÿè°ƒç”¨
        window.recordMood = recordMood;
        window.changeView = changeView;
        window.equipAccessory = equipAccessory;
        window.selectAnimal = selectAnimal;

    </script>
</body>
</html>